<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Heart Pulse Pro - Hybrid AR</title>
  
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; background: #000; }
    
    /* Studio Background (Non-AR) */
    #background-studio {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at center, #ffffff 0%, #dcdcdc 100%);
      z-index: -1; transition: opacity 0.5s;
    }

    /* UI Controls */
    .controls {
      position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 12px; z-index: 1000;
      background: rgba(255, 255, 255, 0.7); padding: 12px; border-radius: 50px;
      backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }

    .heart-btn {
      padding: 12px 24px; border-radius: 40px; border: none;
      background: #222; color: white; font-weight: 600; cursor: pointer;
      transition: all 0.2s; text-transform: uppercase; font-size: 12px;
    }

    .heart-btn.active { background: #e91e63; color: white; transform: scale(1.05); }

    #ar-toggle {
      position: absolute; top: 20px; right: 20px; padding: 15px 20px;
      background: white; border-radius: 12px; z-index: 1001; cursor: pointer;
      font-weight: bold; border: 1px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <div id="background-studio"></div>
  <button id="ar-toggle">ENTER AR</button>

  <a-scene 
    embedded 
    arjs="sourceType: webcam; enabled: false; debugUIEnabled: false;" 
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true; exposure: 1.2; antialias: true;">

    <a-assets>
      <a-asset-item id="heartModel" src="./Heartmodel/Android/Heartmodel.glb"></a-asset-item>
    </a-assets>

    <a-entity camera position="0 1.6 0"></a-entity>

    <a-entity light="type: hemisphere; color: #FFF; groundColor: #666; intensity: 1.5"></a-entity>
    <a-entity light="type: directional; intensity: 1.0; castShadow: true" position="-1 2 1"></a-entity>
    <a-entity light="type: point; intensity: 0.5; distance: 10" position="2 1 -2"></a-entity>

    <a-entity
      id="heartEntity"
      gltf-model="#heartModel"
      position="0 1.4 -3" 
      scale="1.5 1.5 1.5"
      animation-mixer
      heart-gestures>
    </a-entity>

  </a-scene>

  <div class="controls">
    <button class="heart-btn active" data-model="./Heartmodel/Android/Heartmodel.glb" data-audio="false">Heart</button>
    <button class="heart-btn" data-model="./Heartmodel/Android/HeartLabels.glb" data-audio="true">Labels</button>
  </div>

  <audio id="labelAudio" src="./audio/heart_labels_audio.mp3" loop></audio>

  <script>
    // GESTURE SYSTEM: 1-Finger Rotate (Win/Mobile) + 2-Finger Scale (Mobile) + Scroll (Win)
    AFRAME.registerComponent('heart-gestures', {
      init: function () {
        this.lastX = 0;
        this.lastDist = 0;
        this.isDragging = false;

        // Mobile Touch Events
        window.addEventListener('touchstart', (e) => {
          if (e.touches.length === 1) this.lastX = e.touches[0].pageX;
          if (e.touches.length === 2) {
            this.lastDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
          }
        });

        window.addEventListener('touchmove', (e) => {
          if (e.touches.length === 1) {
            let deltaX = e.touches[0].pageX - this.lastX;
            this.el.object3D.rotation.y += deltaX * 0.01;
            this.lastX = e.touches[0].pageX;
          } else if (e.touches.length === 2) {
            let dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            let factor = dist / this.lastDist;
            this.el.object3D.scale.multiplyScalar(factor);
            this.lastDist = dist;
          }
        });

        // Windows Mouse Events
        window.addEventListener('mousedown', (e) => { this.isDragging = true; this.lastX = e.clientX; });
        window.addEventListener('mouseup', () => { this.isDragging = false; });
        window.addEventListener('mousemove', (e) => {
          if (this.isDragging) {
            let deltaX = e.clientX - this.lastX;
            this.el.object3D.rotation.y += deltaX * 0.01;
            this.lastX = e.clientX;
          }
        });

        // Windows Scroll to Scale
        window.addEventListener('wheel', (e) => {
          let delta = e.deltaY > 0 ? 0.95 : 1.05;
          this.el.object3D.scale.multiplyScalar(delta);
        });
      }
    });

    // UI & AR Logic
    const arBtn = document.querySelector('#ar-toggle');
    const studioBg = document.querySelector('#background-studio');
    const scene = document.querySelector('a-scene');
    const heart = document.querySelector('#heartEntity');
    const audio = document.getElementById("labelAudio");

    arBtn.addEventListener('click', () => {
      const isInStudio = studioBg.style.opacity !== '0';
      studioBg.style.opacity = isInStudio ? '0' : '1';
      arBtn.innerText = isInStudio ? 'EXIT AR' : 'ENTER AR';
      
      if (isInStudio) {
        scene.setAttribute('arjs', 'enabled: true; sourceType: webcam;');
      } else {
        scene.setAttribute('arjs', 'enabled: false;');
        const v = document.querySelector('video'); if(v) v.remove();
      }
    });

    document.querySelectorAll('.heart-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.heart-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        heart.setAttribute('gltf-model', btn.dataset.model);
        if (btn.dataset.audio === "true") audio.play().catch(() => {});
        else { audio.pause(); audio.currentTime = 0; }
      });
    });
  </script>
</body>
</html>
