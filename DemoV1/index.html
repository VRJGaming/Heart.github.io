<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Three.js Heart Pro</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }
        #container { width: 100vw; height: 100vh; background: radial-gradient(circle at center, #ffffff 0%, #dcdcdc 100%); }
        
        .controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; z-index: 10;
            background: rgba(255,255,255,0.8); padding: 10px; border-radius: 50px; backdrop-filter: blur(10px);
        }
        .heart-btn {
            padding: 10px 20px; border-radius: 20px; border: none;
            background: #222; color: #fff; cursor: pointer; font-weight: bold;
        }
        .heart-btn.active { background: #e91e63; }
        
        #ar-btn {
            position: absolute; top: 20px; right: 20px; padding: 15px;
            background: #fff; border: 1px solid #ccc; border-radius: 8px; font-weight: bold; cursor: pointer; z-index: 10;
        }
    </style>
</head>
<body>

    <div id="container"></div>
    <button id="ar-btn">START AR</button>

    <div class="controls">
        <button class="heart-btn active" data-path="./Heartmodel/Android/Heartmodel.glb">HEART</button>
        <button class="heart-btn" data-path="./Heartmodel/Android/HeartLabels.glb">LABELS</button>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        let scene, camera, renderer, controls, loader, heart, mixer;
        let clock = new THREE.Clock();

        init();
        animate();

        function init() {
            // 1. Scene & Camera
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 5);

            // 2. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.xr.enabled = true; // Enable WebXR
            renderer.toneMapping = THREE.NeutralToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.getElementById('container').appendChild(renderer.domElement);

            // 3. Lighting (Medical Studio Setup)
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
            dirLight.position.set(2, 2, 5);
            scene.add(dirLight);

            // 4. Controls (The "Override" for 1-finger rotate & scroll zoom)
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 2;
            controls.maxDistance = 10;
            // This forces 1-finger rotation on mobile out of the box
            controls.touches.ONE = THREE.TOUCH.ROTATE; 
            controls.touches.TWO = THREE.TOUCH.DOLLY_PAN;

            // 5. Model Loading
            loader = new GLTFLoader();
            loadModel('./Heartmodel/Android/Heartmodel.glb');

            // 6. AR Setup
            const arButton = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
            document.body.appendChild(arButton);
            // Hide the default AR button and use our custom one to trigger it
            arButton.style.display = 'none';
            document.getElementById('ar-btn').addEventListener('click', () => arButton.click());

            window.addEventListener('resize', onWindowResize);
        }

        function loadModel(path) {
            if (heart) scene.remove(heart);
            loader.load(path, (gltf) => {
                heart = gltf.scene;
                heart.position.set(0, -0.5, 0);
                heart.scale.set(1.5, 1.5, 1.5);
                scene.add(heart);

                // Animation Support
                if (gltf.animations.length) {
                    mixer = new THREE.AnimationMixer(heart);
                    gltf.animations.forEach(clip => mixer.clipAction(clip).play());
                }
            });
        }

        // Handle Button Clicks
        document.querySelectorAll('.heart-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.heart-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                loadModel(btn.dataset.path);
            });
        });

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render() {
            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
